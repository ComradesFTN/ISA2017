<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<script th:src="@{/scripts/jquery-3.2.1.min.js}"></script>
		<link rel="stylesheet" th:href="@{/stylesheets/bootstrap.css}">
		<meta charset="UTF-8">
		<title>Rezervacija filma</title>		
		<script th:inline="javascript">
		/*<![CDATA[*/
			var id;	//?
			var cols;
			var rows;
			var projId;
			var index=-1;
			$(document).ready(function(){	
				rezervacije=[];				
				$(document).data('rezervacije',rezervacije);
				projId = getUrlParameter('id');
				cols = getUrlParameter('cols');
				rows = getUrlParameter('rows');
				$.ajax({
					url : "http://localhost:8080/projections/getSeats/"+projId,
					success : function(data){
							mesta=data;
							$(document).data('mesta',data);						
							for(i=1;i<=rows;i++){
								newRow=  '   <div class="row">  '  + 
								 '   				<div class="btn-group mx-auto">  ';
								for(j=1;j<=cols;j++){
									index+=1;
									classText ="";
									if(mesta[index]===0){
										classText='btn-dark disabled'
									}
									else if(mesta[index]===1){
										classText='btn-secondary'
									}
									else if(mesta[index]===2){
										classText='btn-warning disabled'
									}	
									newRow+= '   				    <button type="button" class="seat '+classText+'" data-id="'+index+'">'+j+'</button>  ' 
								}
								newRow+= '   				 </div>  '  + 
								 '  			</div>  ' ; 
								$("#sala").append(newRow);
							}
						}
				});
				$("#dalje").click(function(event) {
					rezervacije=$(document).data('rezervacije');
					text="";
					for(i=0;i<rezervacije.length;i++){
						text+=rezervacije[i]+' ';
					}
					var loggedUser = /*[[${session.loggedUser.getId()}]]*/ '';
					var confirmed = confirm("Izabrali ste mesta : "+text+" - Potvrdite")
					if(confirmed){
						if(rezervacije.length===1){
							$.ajax({
								var formData = JSON.stringify({
									projectionId : projId,
									seat : rezervacije[0],
									userId : loggedUser,									
								});
								url : "http://localhost:8080/reservations/",
								type : "POST",
								data: formData,
								contentType: "application/json",
								success: function(data){
									alert("Rezervacija je uspesno zavrsena")
									window.location.href = "http://localhost:8080/Posetioci/ticketReservations.html";
								}
							});
						}
						else{
							alert("Za sada samo bleja");
						}
					}
				});
			});
				
			 $(document).on("click", ".seat", function(event){
				event.preventDefault();
				mesta = $(document).data('mesta');
				index=$(this).attr("data-id");
				classText="";
				if(mesta[index]===2){	
					mesta[index]=1;
					rezervacije=$(document).data('rezervacije');
					rezervacije.splice($.inArray(index,rezervacije),1)
					$(document).data('rezervacije',rezervacije);
					classText='seat btn-secondary';				
				}
				else if(mesta[index]===1){
					mesta[index]=2;
					rezervacije=$(document).data('rezervacije');
					rezervacije.push(index);
					$(document).data('rezervacije',rezervacije);
					classText='seat btn-warning';				
				}
				$(document).data('mesta', mesta);
				$(this).attr("class",classText);				
			}); 
			 
			var getUrlParameter = function getUrlParameter(sParam) {
			    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
			        sURLVariables = sPageURL.split('&'),
			        sParameterName,
			        i;

			    for (i = 0; i < sURLVariables.length; i++) {
			        sParameterName = sURLVariables[i].split('=');

			        if (sParameterName[0] === sParam) {
			            return sParameterName[1] === undefined ? true : sParameterName[1];
			        }
			    }
			};			
			/*]]>*/
		</script>	
	</head>	
	<body class="bg-light">			
		<div class="nav nav-tabs bg-danger">
			<ul class="nav nav-tabs mr-auto bg-danger">			
				<li class="nav-item">
					<a class="nav-link text-white" href="theatresPage.html">Pozorista</a>				
				</li>
				<li class="nav-item">
					<a class="nav-link text-white" href="homePage.html">Home</a>
				</li>
				<li class="nav-item">
					<a class="nav-link text-white" th:href="cinemasPage.html">Bioskopi</a>
				</li>
				<li class="nav-item">
					<a class="nav-link text-white" th:href="friends.html">Prijatelji</a>
				</li>	
				<li class="nav-item">
					<a class="nav-link text-white" href="cinemasPage.html">Rezervacije</a>
				</li>	
				<li class="nav-item">
					<a class="nav-link text-white" th:href="settings.html">Podesavanja</a>
				</li>	
				<li class="nav-item">
					<a class="nav-link text-white" href="fanZonaPage.html">Fan Zona</a>
				</li>					
			</ul>
			<a class="nav-link mr-0 text-white" href="/index.html">Odjava</a>
		</div>	
		<div class="container col-md-4 mt-5 text-center">
			<div class="row">
				<div class="btn-group mx-auto"> 
				    <button type="button" class="btn btn-dark">Nedostupno mesto</button>
				    <button type="button" class="btn btn-secondary">Slobodno mesto</button>
				    <button type="button" class="btn btn-warning">Rezervisano mesto</button>
				 </div>
			</div>
		</div>
		<br/>
		<div id="sala" class="container col-md-4 mt-5 text-center">			
			
		</div>
		<div class="container col-md-4 mt-5 text-center">			
			<div class="row">		
				<div class="mx-auto"> 
				    <form>
		    			<input type="submit" id="dalje" value="Rezervisi" class="btn btn-danger" />
		    		</form>
	    		</div>	   
			 </div>
		</div>
	</body>
</html>