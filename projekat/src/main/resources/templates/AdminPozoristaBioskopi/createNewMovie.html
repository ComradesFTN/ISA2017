<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
	<head>
		<script th:src="@{/scripts/jquery-3.2.1.min.js}"></script>
		<script th:src="@{/scripts/bootstrap.js}"></script>	
		<link rel="stylesheet" th:href="@{/stylesheets/bootstrap.css}">
		<meta charset="UTF-8">		
		<title>Novi film</title>
		<script>
			var termini;
			$(document).ready(function(){				
				var id = getUrlParameter('id');	
				$("#repertoar").attr("href", "cinemaRepertoar.html?id="+id);
				$.ajax({
					url : "http://localhost:8080/cinemas/"+id
				}).then(
						function(data) {	
							input = "";
							for(j = 0; j<data.auditoriums.length; j++){
								input+=' <input type="checkbox" class="ml-2" id="inputSala'+data.auditoriums[j].id+'"> '+data.auditoriums[j].name+'<br/>';
							}
							$("#Sale").append(input);
						});
				$("#Add").click(function(){
					var provera = /([1]?[0-9]|2[0-3]):[0-5][0-9]/;
					input=$(#inputTerm).val();
					var dobar = provera.test(input);
					var termin="";
					if(dobar){						
						termin='<br/>'+input+'<br/>';
						termini.push(input);
					}
					$("#terms").append(termin);
				});
			});			
			
			var getUrlParameter = function getUrlParameter(sParam) {
			    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
			        sURLVariables = sPageURL.split('&'),
			        sParameterName,
			        i;

			    for (i = 0; i < sURLVariables.length; i++) {
			        sParameterName = sURLVariables[i].split('=');

			        if (sParameterName[0] === sParam) {
			            return sParameterName[1] === undefined ? true : sParameterName[1];
			        }
			    }
			};
			$("input[type='submit']").click(function(event) {
				event.preventDefault();				
				function validate(){
					if ($('#inputName').val() == "" || $('#inputDescription').val() == "" || $('#inputDirectorName').val() == "" || $('#inputGenre').val() == "" || $('#inputLength').val() == "" {
				        alert("Pri kreiranju oglasa, obavezna polja su naziv, režiser, žanr, opis i trajanje ");//odradi za termine jos
				        $('#inputName').focus();
				        return false;
				    }
					
					return true;
				}  
				if(!validate()){
					return;
				}
				var sale = [];
				for(j = 0; j<data.auditoriums.length; j++)
					if($("#inputSala"+data.auditoriums[j].id).checked){
						sale.push({"id":data.auditoriums[j].id});
					}
				}
				if(sale.length===0){
					 alert("Morate izabrati barem jednu salu za projekciju filma");
					 return;
				}
				if(reader!=null){
					var splitImage = reader.result.split('base64,');					
					var formData = JSON.stringify({
						name:$("#inputName").val(),
						directorName:$("#inputDirectorName").val(),
						genre:$("#inputGenre").val(),
						length:$("#inputLength").val(),
						description:$("#inputDescription").val(),
						auditoriums:sale,
						image:splitImage[1],
						
					});
						$.ajax({
							url: "http://localhost:8080/movies",
							type: 'POST',
							data: formData,
							contentType: "application/json",
							success: function(data){
								$.ajax({
									url: "http://localhost:8080/cinemas/"+id+"/addMovie/"+data.id,
									type: 'PUT',
								}
								success: function(){
									window.location.href = "http://localhost:8080/AdminPozoristaBioskopi/cinemaRepertoar.html?id="+id";
								}
							}
						});
				}else{
					var formData = JSON.stringify({
						name:$("#inputName").val(),
						description:$("#inputDescription").val(),
						date:$("#inputDate").val(),
					});
						$.ajax({
							url: "http://localhost:8080/userAd",
							type: 'POST',
							data: formData,
							contentType: "application/json",
							success: function(){
								console.log("Ajax zahtev za registraciju.");
								alert("Vas oglas je poslat, molimo sacekajte da administrator odobri vas oglas.");
								window.location.href = "http://localhost:8080/Posetioci/polovniOglasi.html";
							}
						});
				}
			});
			
		</script>
	</head>	
	<body>
		<body class="bg-light">			
		<div class="nav nav-tabs bg-danger">
			<ul class="nav nav-tabs mr-auto bg-danger">
				<li class="nav-item">
					<a class="nav-link text-white" href="homePage.html">Home</a>
				</li>					
				<li class="nav-item">
					<a class="nav-link text-white" href="theatresPage.html">Pozorista</a>				
				</li>
				<li class="nav-item">
					<a class="nav-link active text-danger" href="cinemasPage.html">Bioskopi</a>
				</li>			
			</ul>
			<a class="nav-link mr-0 text-white" href="../NeregistrovaniKorisnici/login.html">Odjava</a>
		</div>
		<nav class="navbar bg-dark justify-content-center">
		    <div>
		        <div class="nav nav-pills bg-dark flex-row">
					<ul class="nav nav-tabs bg-danger flex-row ">	
						<li class="nav-item">
							<a class="nav-link text-white" id="home" href="#">Home</a>				
						</li>		
						<li class="nav-item">
							<a class="nav-link active text-danger">Repertoar</a>				
						</li>
						<li class="nav-item">
							<a class="nav-link text-white" href="cinemaPopusti.html">Popusti</a>
						</li>
					</ul>
				</div>
		    </div>
		</nav>
		<div class="container col-md-4 mt-5">
			<form>
			  <div class="form-group row">
				    <label for="inputImage" class="col-sm-2 col-form-label">Poster</label>
				    <div class="col-sm-10">
			     		 <input type="file" onchange="previewFile()"><br>
				 		 <img src="" height="200" alt="Pregled slike...">
			    	</div>
			  </div>
			  <div class="form-group row">
			    <label for="inputName" class="col-sm-2 col-form-label">Naziv</label>
			    <div class="col-sm-10">
			      <input type="text" class="ml-2" id="inputName" placeholder="Naziv">
			    </div>
			  </div>
			  
			  <div class="form-group row">
			    <label for="inputActors" class="col-sm-2 col-form-label">Glumci</label>
			    <div class="col-sm-10">
			      <input type="text" class="ml-2" id="inputActors" placeholder="Glumci">
			    </div>
			  </div>
			  
			  <div class="form-group row">
			    <label for="inputDirectorName" class="col-sm-2 col-form-label">Režiser</label>
			    <div class="col-sm-10">
			      <input type="text" class="ml-2" id="inputDirectorName" placeholder="Režiser">
			    </div>
			  </div>
			  
			  <div class="form-group row">
			    <label for="inputGenre" class="col-sm-2 col-form-label">Žanr</label>
			    <div class="col-sm-10">
			      <input type="text" class="ml-2" id="inputGenre" placeholder="Žanr">
			    </div>
			  </div>
			  
			  <div class="form-group row">
			    <label for="inputLength" class="col-sm-2 col-form-label">Trajanje</label>
			    <div class="col-sm-10">
			      <input type="number" class="ml-2" id="inputLength" placeholder="Trajanje">
			    </div>
			  </div>
			  
			  <div class="form-group row">
			    <label for="inputDescription" class="col-sm-2 col-form-label">Opis</label>
			    <div class="col-sm-10">
			      <input type="text" class="ml-2" id="inputDescription" placeholder="Opis">
			    </div>
			  </div>
			  
			  <div class="form-group row">
			    <label class="col-sm-2 col-form-label">Sale</label>
			    <div id="Sale" class="col-sm-10">
			    </div>
			  </div>
			  <div class="form-group row">  <!-- isto tako u div za termine punicu termine (dodam novi input na dugme neko --> 			    
			    <div id="terms" class="col-sm-10">
			      Termini <input type="text" class="ml-2" id="inputTerm" placeholder="Termin"> <button class="btn btn-success" type="button">+</button>
			    </div>
			  </div>
			  
			  
			  <div class="form-group row">
			    <div class="col-sm-10">
	    			<input type="submit" value="Dodaj film" class="btn btn-danger" />
			    </div>
			  </div>
			</form>
		</div>
	</body>
</html>